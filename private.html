<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Private Area — Feel Coast</title>

<style>
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #000;
    color: #fff;
  }

  * { box-sizing: border-box; }

  .wrapper {
    width: 100%;
    min-height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 18px;
  }

  .card {
    width: 100%;
    max-width: 460px;
    padding: 36px 28px;
    background: rgba(0,0,0,0.82);
    box-shadow: 0 24px 80px rgba(0,0,0,0.85);
    text-align: center;
    border-radius: 14px;
    backdrop-filter: blur(8px);
  }

  h1 {
    font-size: 14px;
    letter-spacing: 0.32em;
    margin: 0 0 22px;
    opacity: 0.95;
  }

  .login-stack {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 14px;
    margin-top: 6px;
  }

  input {
    width: 100%;
    max-width: 260px;
    padding: 14px 12px;
    background: rgba(0,0,0,0.7);
    border: 1px solid rgba(255,255,255,0.22);
    color: #fff;
    font-size: 16px;
    text-align: center;
    letter-spacing: 0.45em;
    border-radius: 10px;
    outline: none;
  }

  input:focus {
    border-color: rgba(255,255,255,0.45);
  }

  button {
    width: 100%;
    max-width: 260px;
    padding: 14px;
    background: #fff;
    color: #000;
    border: none;
    font-size: 12px;
    letter-spacing: 0.28em;
    cursor: pointer;
    border-radius: 10px;
  }

  button:active {
    transform: translateY(1px);
  }

  .error {
    margin-top: 14px;
    font-size: 12px;
    color: rgba(255,255,255,0.55);
    display: none;
  }

  .dashboard {
    display: none;
    max-width: 980px;
    text-align: left;
    background: transparent;
    box-shadow: none;
    border: none;
    padding: 0;
  }

  .issues {
    font-size: 13px;
    border-top: 1px solid rgba(255,255,255,0.08);
  }

  .issue {
    padding: 18px 16px;
    margin: 18px 0;
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 14px;
    position: relative;
    background: rgba(0,0,0,0.55);
  }

  .issue-title {
    font-weight: 600;
    letter-spacing: 0.02em;
    margin-bottom: 6px;
  }

  .issue-body {
    opacity: 0.7;
    line-height: 1.45;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .delete-btn {
    position: static;
    margin: 12px auto 0;
    display: block;
    font-size: 10px;
    letter-spacing: 0.14em;
    background: transparent;
    color: rgba(255,255,255,0.55);
    border: 1px solid rgba(255,255,255,0.25);
    padding: 4px 10px;
    border-radius: 5px;
    cursor: pointer;
  }

  .delete-btn:hover {
    color: #fff;
    border-color: rgba(255,255,255,0.5);
  }

  .row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 14px;
  }

  .ghost {
    font-size: 12px;
    color: rgba(255,255,255,0.45);
    cursor: pointer;
    text-decoration: none;
    letter-spacing: 0.02em;
    white-space: nowrap;
  }

  .ghost:hover { color: rgba(255,255,255,0.65); }

  .small {
    font-size: 12px;
    opacity: 0.6;
  }

  @media (max-width: 420px) {
    .card { padding: 32px 20px; }
    input, button { max-width: 100%; }
  }
</style>
</head>

<body>

<div class="wrapper">

  <!-- LOGIN CARD -->
  <div class="card" id="loginCard">
    <h1>PRIVATE AREA</h1>

    <div class="login-stack">
      <input type="password" id="pin" placeholder="PIN" maxlength="8" inputmode="numeric" autocomplete="one-time-code" />
      <button id="enterBtn" type="button">ENTER</button>
    </div>

    <div class="error" id="error">Wrong PIN</div>

    <div style="margin-top:22px;">
      <a class="ghost" href="index.html">← Back to home</a>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="card dashboard" id="dashboard">
    <div class="row" style="flex-direction:column; align-items:center; position:relative; margin-bottom:28px;">
      <a class="ghost" href="index.html" style="position:absolute; left:0; top:0;">← Back to home</a>
      <h1 style="margin:22px 0 0; text-align:center;">ADMIN</h1>
    </div>

    <!-- analytics stats (no border, no flicker) -->
    <div id="stats" class="issues" style="border:none; padding:0; margin-bottom:24px;"></div>

    <!-- requests -->
    <div id="issues" class="issues"></div>
    <p class="small" id="meta" style="margin-top:14px;"></p>
  </div>

</div>

<script>
  const CORRECT_PIN = '5982';
  const ISSUES_ENDPOINT = 'https://cool-haze-b97a.tanzaniagetaway-info.workers.dev/issues';
  const ANALYTICS_ENDPOINT = 'https://cool-haze-b97a.tanzaniagetaway-info.workers.dev/analytics';

  function getEl(id) { return document.getElementById(id); }
  function show(el) { el.style.display = 'block'; }
  function hide(el) { el.style.display = 'none'; }

  function cleanIssueBody(raw) {
    const rawBody = (raw || '').toString();
    return rawBody
      // remove URLs (form links)
      .replace(/https?:\/\/[^\s]+/gi, '')
      // remove TYPE / PAGE lines
      .split('\n')
      .filter(line => !/^\s*(TYPE|PAGE)\s*:/i.test(line))
      .join('\n')
      .trim();
  }

  async function deleteIssue(issueId, elToRemove) {
    const ok = confirm('Delete this request?');
    if (!ok) return;

    try {
      const res = await fetch(`${ISSUES_ENDPOINT}/${encodeURIComponent(issueId)}`, { method: 'DELETE' });
      if (!res.ok) throw new Error('Delete failed (HTTP ' + res.status + ')');
      elToRemove.remove();
    } catch (err) {
      alert('Unable to delete request');
      console.error(err);
    }
  }

  // ---------- Analytics (no flicker) ----------
  async function loadAnalytics({ silent = true } = {}) {
    const box = getEl('stats');

    // Build once
    if (!box.dataset.ready) {
      box.dataset.ready = '1';
      box.innerHTML = `
        <div class="issue" id="statsCard" style="display:flex;justify-content:space-between;text-align:center;">
          <div><div class="small">TODAY</div><div id="statToday">-</div></div>
          <div><div class="small">WEEK</div><div id="statWeek">-</div></div>
          <div><div class="small">MONTH</div><div id="statMonth">-</div></div>
        </div>
      `;
    }

    const elToday = getEl('statToday');
    const elWeek = getEl('statWeek');
    const elMonth = getEl('statMonth');

    try {
      const res = await fetch(ANALYTICS_ENDPOINT, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();

      elToday.textContent = String(data.today ?? '-');
      elWeek.textContent = String(data.week ?? '-');
      elMonth.textContent = String(data.month ?? '-');
    } catch (e) {
      if (!silent) {
        elToday.textContent = '-';
        elWeek.textContent = '-';
        elMonth.textContent = '-';
      }
      console.error(e);
    }
  }

  // ---------- Issues (diff update, no flicker) ----------
  function upsertIssueElement(container, issue) {
    const id = String(issue.id);
    let el = container.querySelector(`.issue[data-issue-id="${CSS.escape(id)}"]`);

    const titleText = issue && issue.title ? issue.title : '(no title)';
    const bodyText = cleanIssueBody(issue && issue.body ? issue.body : '');

    if (!el) {
      el = document.createElement('div');
      el.className = 'issue';
      el.dataset.issueId = id;

      const title = document.createElement('div');
      title.className = 'issue-title';

      const body = document.createElement('div');
      body.className = 'issue-body';

      el.appendChild(title);
      el.appendChild(body);

      const del = document.createElement('button');
      del.className = 'delete-btn';
      del.type = 'button';
      del.textContent = 'DELETE';
      del.addEventListener('click', () => deleteIssue(issue.id, el));
      el.appendChild(del);

      container.appendChild(el);
    }

    const titleEl = el.querySelector('.issue-title');
    const bodyEl = el.querySelector('.issue-body');

    if (titleEl && titleEl.textContent !== titleText) titleEl.textContent = titleText;
    if (bodyEl && bodyEl.textContent !== bodyText) bodyEl.textContent = bodyText;

    return el;
  }

  function reconcileIssues(container, list) {
    const keep = new Set(list.map(x => String(x.id)));

    // Remove missing
    const existing = Array.from(container.querySelectorAll('.issue[data-issue-id]'));
    for (const el of existing) {
      if (!keep.has(String(el.dataset.issueId))) el.remove();
    }

    // Upsert and re-order
    for (const issue of list) upsertIssueElement(container, issue);

    const ordered = list
      .map(i => container.querySelector(`.issue[data-issue-id="${CSS.escape(String(i.id))}"]`))
      .filter(Boolean);

    for (const el of ordered) container.appendChild(el);
  }

  let _issuesFetchInFlight = null;

  async function loadIssues({ silent = true } = {}) {
    const container = getEl('issues');
    const meta = getEl('meta');

    // First paint only
    if (!container.dataset.ready) {
      container.dataset.ready = '1';
      container.innerHTML = '<div class="issue" data-issue-id="_loading"><div class="issue-body">Loading…</div></div>';
      meta.textContent = '';
    }

    if (_issuesFetchInFlight) return;

    const ctrl = new AbortController();
    _issuesFetchInFlight = ctrl;

    try {
      const res = await fetch(ISSUES_ENDPOINT, { cache: 'no-store', signal: ctrl.signal });
      if (!res.ok) throw new Error('HTTP ' + res.status);

      const data = await res.json();
      const list = Array.isArray(data) ? data : [];

      // Remove loading placeholder
      const loading = container.querySelector('.issue[data-issue-id="_loading"]');
      if (loading) loading.remove();

      if (!list.length) {
        if (!container.querySelector('.issue[data-issue-id="_empty"]')) {
          container.innerHTML = '<div class="issue" data-issue-id="_empty"><div class="issue-body">No requests yet.</div></div>';
        }
        meta.textContent = 'Loaded 0 item(s).';
        return;
      }

      // Remove empty placeholder if present
      const empty = container.querySelector('.issue[data-issue-id="_empty"]');
      if (empty) empty.remove();

      reconcileIssues(container, list);
      meta.textContent = `Loaded ${list.length} item(s).`;
    } catch (e) {
      const hasAny = !!container.querySelector('.issue[data-issue-id]:not([data-issue-id="_loading"])');
      if (!silent && !hasAny) {
        container.innerHTML = '<div class="issue" data-issue-id="_error"><div class="issue-body">Error loading requests. Check the Worker endpoint.</div></div>';
      }
      // Don’t wipe UI on background refresh
      meta.textContent = (e && e.name === 'AbortError') ? meta.textContent : String(e && e.message ? e.message : e);
      console.error(e);
    } finally {
      _issuesFetchInFlight = null;
    }
  }

  // ---------- Realtime refresh ----------
  let _refreshTimer = null;

  function startRealtimeRefresh() {
    if (_refreshTimer) return;

    // First paint (visible)
    loadAnalytics({ silent: false });
    loadIssues({ silent: false });

    // Background refresh (no flicker)
    _refreshTimer = setInterval(() => {
      if (document.hidden) return;
      loadAnalytics({ silent: true });
      loadIssues({ silent: true });
    }, 30000);

    window.addEventListener('focus', () => {
      loadAnalytics({ silent: true });
      loadIssues({ silent: true });
    });
  }

  function checkPin() {
    const pin = (getEl('pin').value || '').trim();

    if (pin === CORRECT_PIN) {
      hide(getEl('loginCard'));
      show(getEl('dashboard'));
      startRealtimeRefresh();
      return;
    }

    show(getEl('error'));
  }

  // Small self-tests (non-blocking) to catch common regressions in console.
  function runSelfTests() {
    try {
      console.assert(cleanIssueBody('TYPE: x\nHello\nPAGE: y').includes('Hello'), 'cleanIssueBody should keep content');
      console.assert(!/^TYPE:/i.test(cleanIssueBody('TYPE: x\nHello')), 'cleanIssueBody should remove TYPE lines');
      console.assert(!/^PAGE:/i.test(cleanIssueBody('PAGE: x\nHello')), 'cleanIssueBody should remove PAGE lines');
      console.assert(cleanIssueBody('Visit https://example.com now').includes('Visit'), 'cleanIssueBody should keep text around URLs');
    } catch (_) {}
  }

  document.addEventListener('DOMContentLoaded', () => {
    const pin = getEl('pin');
    const btn = getEl('enterBtn');

    btn.addEventListener('click', checkPin);
    pin.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        checkPin();
      }
    });

    pin.addEventListener('input', () => {
      hide(getEl('error'));
    });

    runSelfTests();
    pin.focus();
  });
</script>

</body>
</html>
